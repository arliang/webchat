WE.pageChat={isLoading:0,lastTime:null,replyTo:null,isPosting:0,eleId:1,postList:[],isPostInputFocus:!0,init:function(){this.ui={postBox:$("#post-box"),replayBox:$("#replay-box")};WE.pageChat.tabSelect.init();this.regEvent()},regEvent:function(){var a=this;this.ui.postBox.find(".text-box input").keyup(function(b){13==b.keyCode&&(b=$.trim($(this).val()),""==b||a.isPosting||(a.post(ROOM.id,b,a.replyTo),a.postList.push(a.eleId),WE.pageChat.timeLine.append({eleId:"my-talk-"+a.eleId,_id:"",aim:null,del:0,
from:{_id:USER._id,avatar:USER.avatar,name:USER.name,summary:USER.summary},roomid:ROOM.id,text:b,time:"...",to:"*"}),a.eleId++))});$("#timeline-bar").bind("scroll",function(){var b=$(this);0==a.isLoading?0==b.scrollTop()&&0<WE.pageChat.timeLine.leave_count&&(a.isLoading=1,a.getMore()):2==a.isLoading&&0==b.scrollTop()&&a.noMoreTips()});this.ui.postBox.find(".text-box input").focus(function(){a.isPostInputFocus=!0}).blur(function(){a.isPostInputFocus=!1});$(window).keydown(function(b){13==b.keyCode&&
(a.isPostInputFocus||(a.ui.postBox.find(".text-box input").css("background","#FFF8C5"),setTimeout(function(){a.ui.postBox.find(".text-box input").css("background","none")},1500)),a.ui.postBox.find(".text-box input").focus(),a.ui.postBox.find(".text-box input").keyup())})},tipsTimeout:null,noMoreTips:function(){clearTimeout(this.tipsTimeout);$("#more-talks .tips").text("\u6ca1\u6709\u66f4\u591a\u4fe1\u606f\u4e86...");$("#more-talks").fadeIn();this.tipsTimeout=setTimeout(function(){$("#more-talks").fadeOut()},
2E3)},getMore:function(){$("#more-talks").fadeIn();var a=this,b=new WE.api.RoomModel,c=new WE.Controller;c.update=function(b){var c=b.data;setTimeout(function(){0==c.code&&c.result.length?(a.isLoading=0,WE.pageChat.timeLine.leave_count-=c.result.length,WE.pageChat.timeLine.prepends(c.result)):a.isLoading=2;$("#more-talks").fadeOut()},500)};c.error=function(){$("#more-talks").fadeOut()};b.addObserver(c);b.getMore(ROOM.id,this.lastTime)},post:function(a,b,c){var d=this;this.isPosting=!0;aim=null==c?
void 0:c;d=this;c=new WE.api.RoomModel;var e=new WE.Controller;e.update=function(a){0==a.data.code&&(d.ui.postBox.find(".text-box input").val(""),d.hideReply());d.replyTo=null;d.isPosting=!1};c.addObserver(e);c.postChat(a,b,aim)},setReply:function(a){var b=this;this.replyTo=a._id;this.ui.replayBox.html(WE.kit.tmpl(this.replyTmpl,a));this.ui.replayBox.removeClass("hidden");this.ui.replayBox.find(".close-btn").click(function(){b.ui.replayBox.empty();b.ui.replayBox.addClass("hidden")});this.ui.postBox.find(".text-box input").focus()},
hideReply:function(){this.ui.replayBox.empty();this.ui.replayBox.addClass("hidden")},replyTmpl:'<div class="replay-box">\t\t\t\t\t<div class="arrow"></div>\t\t\t\t\t<span class="icon-close close-btn"></span>\t\t\t\t\t<div>\t\t\t\t\t\t<a href="/user/<%=from._id%>" target="_blank" class="name"><%=from.name == ""? "(\u6682\u65e0\u6635\u79f0)" : from.name %></a> : \t\t\t\t\t</div>\t\t\t\t\t<div class="context"><%=text %></div>\t\t\t\t</div>'};
WE.pageChat.activation={init:function(){this.ui={openBtn:$("#activation-open-btn")};this.regEvent()},regEvent:function(){var a=this;this.ui.openBtn.click(function(){a.open()})},open:function(){var a=new WE.api.RoomModel,b=new WE.Controller;b.update=function(a){a.data.result&&location.reload()};a.addObserver(b);a.setRoomOpen(ROOM.id)},close:function(){var a=new WE.api.RoomModel,b=new WE.Controller;b.update=function(a){a.data.result&&location.reload()};a.addObserver(b);a.setRoomClose(ROOM.id)}};
WE.pageChat.login={isLogin:!1,init:function(){this.ui={nickNameInput:$("#login-nickname-input"),nickNameBtn:$("#login-nickname-btn"),nickNameWall:$("#login-nickname-wall")};this.regEvent()},regEvent:function(){var a=this;this.ui.nickNameInput.keyup(function(b){var c=$.trim(a.ui.nickNameInput.val());""!=c?a.ui.nickNameBtn.find(".icon-go").addClass("icon-go-click"):a.ui.nickNameBtn.find(".icon-go").removeClass("icon-go-click");13!=b.keyCode||""==c||a.isLogin||(a.ui.nickNameBtn.find(".icon-go").removeClass("icon-go-click"),
a.nickNameLogin(c))});this.ui.nickNameBtn.click(function(){var b=$.trim(a.ui.nickNameInput.val());""!=b&&(a.ui.nickNameBtn.find(".icon-go").removeClass("icon-go-click"),a.nickNameLogin(b))})},nickNameLogin:function(a){var b=this;b.isLogin=!0;b.ui.nickNameBtn.find(".icon-go").addClass("hidden");b.ui.nickNameBtn.find(".icon-loading").removeClass("hidden");var c=new WE.api.UserModel,d=new WE.Controller;d.update=function(a){0==a.data.code&&($("#wall-room").removeClass("login-style"),location.reload());
setTimeout(function(){b.isLogin=!1;b.ui.nickNameBtn.find(".icon-go").removeClass("hidden");b.ui.nickNameBtn.find(".icon-loading").addClass("hidden")},1E3)};c.addObserver(d);c.updateUserName(a)}};
WE.pageChat.timeLine={tmpl:'<div class="talk <% if( from._id == USER._id ){ %> me <% } %>" <% if( typeof obj.eleId != "undefined" ){ %> id="<%=obj.eleId %>" <% } %>>\t\t\t\t<div class="photo">\t\t\t\t\t<a href="/user/<%=from._id%>" target="_blank" data-uid="<%=from._id%>">\t\t\t\t\t\t<img src="<%=from.avatar%>">\t\t\t\t\t</a>\t\t\t\t</div>\t\t\t\t<div class="info">\t\t\t\t\t<div class="head">\t\t\t\t\t\t<a href="/user/<%=from._id%>" target="_blank" class="name <% if(from.name==""){ %> no-name <% } %>"><%= from.name == ""? "(\u6682\u65e0\u6635\u79f0)" : from.name %></a>\t\t\t\t\t\t<a target="_blank" href="/d/<%=_id%>" class="time">\t\t\t\t\t\t\t<% if( time == "..." ){ %>\t\t\t\t\t\t\t\t...\t\t\t\t\t\t\t<% }else{ %>\t\t\t\t\t\t\t\t<%=WE.kit.weFormat( time*1000 ) %>\t\t\t\t\t\t\t<% } %>\t\t\t\t\t\t</a>\t\t\t\t\t</div>\t\t\t\t\t<% if(obj.aim){ %>\t\t\t\t\t<div class="reply"><%=aim.text%></div>\t\t\t\t\t<% } %>\t\t\t\t\t<div class="context">\t\t\t\t\t\t<%=WE.markdown.format(text)%><a href="javascript:;" data-mid="<%=_id%>" class="icon-reply chat-reply" title="\u56de\u590d"></a>\t\t\t\t\t</div>\t\t\t\t</div>\t\t\t</div>',mapData:{},
init:function(a,b){var c=this,d=0,e=a.length;c.chats_count=b;for(c.leave_count=30<b?b-30:0;d<e;d++)this.mapData[a[d]._id]=a[d];this.appends(a);e&&a[0].time?WE.pageChat.lastTime=a[0].time:(WE.pageChat.isLoading=2,WE.pageChat.lastTime=-1);$("#timeline-talks").delegate(".chat-reply","click",function(){var a=$(this).attr("data-mid");(chat=c.mapData[a])&&WE.pageChat.setReply(chat)})},append:function(a){""!=this.mapData[a._id]&&(this.mapData[a._id]=a);$("#timeline-talks").append(WE.kit.tmpl(this.tmpl,a));
$("#timeline-bar").scrollTop(99999)},appends:function(a){for(var b=0,c=a.length,d="";b<c;b++)this.mapData[a[b]._id]=a[b],d+=WE.kit.tmpl(this.tmpl,a[b]);$("#timeline-talks").append(d);a[0]&&a[0].time?WE.pageChat.lastTime=a[0].time:console.log("lastTime \u5931\u8d25");$("#timeline-bar").scrollTop(99999)},prepends:function(a){for(var b=0,c=a.length,d="";b<c;b++)this.mapData[a[b]._id]=a[b],d+=WE.kit.tmpl(this.tmpl,a[b]);b=$(d);b.insertAfter($("#more-talks"));var e=0;$.each(b,function(a,b){e+=b.offsetHeight});
$("#timeline-bar").scrollTop(e-20);a[0].time?WE.pageChat.lastTime=a[0].time:console.log("lastTime \u5931\u8d25")},updatePost:function(a,b){this.mapData[b._id]=b;var c=$("#my-talk-"+a);c.find(".chat-reply").attr("data-mid",b._id);c.find(".time").text(WE.kit.weFormat(1E3*b.time))}};
WE.pageChat.tabSelect={init:function(){this.ui={tab:$("#tab-select"),content:$("#tab-content")};this.regEvent()},regEvent:function(){var a=this;this.ui.tab.find("a").click(function(){a.ui.content.find(".tab-wall-cell").hide();a.ui.tab.find("a").removeClass("select");$(this).addClass("select")})}};
WE.pageChat.userlist={tmpl:'<li id="uid_<%=_id%>" class="<% if( _id == USER._id){ %> me <% } %><% if( typeof obj.online != "undefined" ){ %> insert-li <% } %>" >\t\t\t\t<a href="/user/<%=_id%>" target="_blank"  class="name <% if(name == ""){ %>no-name<% } %>" >\t\t\t\t\t<img src="<%=avatar%>"><%= name == ""? "(\u6682\u65e0\u6635\u79f0)" : name%>\t\t\t\t</a>\t\t\t</li>',data:null,init:function(a){var b=a.length-1,c="";if(a){this.data=a;for(c+=WE.kit.tmpl(this.tmpl,USER);0<=b;b--)this.data[b]._id!=
USER._id&&(c+=WE.kit.tmpl(this.tmpl,a[b]));$("#user-list").empty().html(c)}this.ui={onlineBtn:$("#online-btn"),content:$("#online")};this.regEvent()},regEvent:function(){var a=this;this.ui.onlineBtn.click(function(){a.ui.content.show()})},append:function(a){if(a._id!=USER._id){this.data?this.data.push(a):this.data=[a];a.online=!0;var b=WE.kit.tmpl(this.tmpl,a);setTimeout(function(){$("#uid_"+a._id).removeClass("insert-li")},300);$("#user-list li").eq(0).after(b)}},remove:function(a){var b=this.data;
$("#uid_"+a._id).remove();for(var c=0;c<b.length;c++)if(b[c]._id==a._id){b.splice(c,1);break}}};
WE.pageChat.historylist={isLoadData:!1,tmpl:'<li>\t\t\t    <a href="/user/<%=_id%>" target="_blank" title="<%=name%>">\t\t\t\t\t<img src="<%=avatar%>">\t\t\t\t</a>\t\t    </li>',init:function(){this.ui={wall:$("#history"),list:$("#history-list"),activeBtn:$("#history-btn")};this.regEvent()},regEvent:function(){var a=this;this.ui.activeBtn.click(function(){a.displayHistory()})},displayHistory:function(){var a=this;if(!this.isLoadData){var b=new WE.api.RoomModel,c=new WE.Controller;c.update=function(b){b=
b.data;var c="";if(0==b.code){a.isLoadData=!0;for(var f=0;f<b.result.length;f++)c+=WE.kit.tmpl(a.tmpl,b.result[f]);a.ui.list.empty().html(c)}};b.addObserver(c);b.historyList(ROOM.id)}this.ui.wall.show()}};
WE.pageChat.invite={selectList:{mail:[],user:[]},datas:[],isGetData:!1,isSending:!1,mailInputList:[],init:function(){var a=$("#invite");this.ui={wall:$("#wall-room"),inviteWall:a,boot:$("#invite-btn"),close:a.find(".js-close-btn"),usersList:$("#users-list"),emailInput:a.find(".email-input"),emailTips:a.find(".email-input .error-tips"),submit:$("#invite-submit")};this.regEvent()},regEvent:function(){var a=this;this.ui.boot.click(function(){a.ui.wall.addClass("invite-style");a.ui.close.find("i").addClass("animate");
a.isGetData?a.addUsers(a.datas):a.getUserList()});this.ui.close.click(function(){a.ui.wall.removeClass("invite-style");a.ui.usersList.empty();a.ui.emailInput.find("input").val("");a.selectList.mail=[];a.selectList.user=[];a.ui.close.removeClass("animate")});this.ui.usersList.find(".cell").click(function(){var a=$(this);a.index();var c=a.hasClass("select-cell");c?a.removeClass("select-cell"):a.addClass("select-cell");c?a.find(".select").addClass("hidden"):a.find(".select").removeClass("hidden");c?
a.find(".invite").show():a.find(".invite").hide()});this.ui.emailInput.find("input").keyup(function(b){var c=$.trim(a.ui.emailInput.find("input").val());if(13==b.keyCode&&""!=c){if(!/^[^@]+@[^@]+$/.test(c))return a.ui.emailTips.text("Please input email").show(),setTimeout(function(){a.ui.emailTips.hide()},2E3),!1;b=a.selectList.mail.length;for(var d=a.selectList.mail,e=!1,f=0;f<b;f++)if(d[f].mail==c){e=!0;a.ui.emailTips.text("\u90ae\u7bb1\u5df2\u7ecf\u5b58\u5728").show();setTimeout(function(){a.ui.emailTips.hide()},
2E3);break}e||a.addUser({mail:c},!0);a.ui.emailInput.find("input").val("")}});this.ui.emailInput.find("input").focus(function(){a.ui.emailTips.hide()});this.ui.submit.click(function(){if(a.selectList.mail.length||a.selectList.user.length)a.isSending||a.invitePost()})},addUser:function(a,b){(new WE.pageChat.inviteCell(a,b)).prepend(this.ui.usersList)},addUsers:function(a){for(var b=a.length,c=0;c<b;c++)this.addUser(a[c].to,!1)},getUserList:function(){var a=this,b=new WE.api.UserModel,c=new WE.Controller;
c.update=function(b){b=b.data;0==b.code&&(a.isGetData=!0,a.datas=b.result,a.addUsers(a.datas))};b.addObserver(c);b.getContactList()},invitePost:function(){var a=this;this.isSending=!0;this.ui.submit.text("\u53d1\u9001\u4e2d...");var b=new WE.api.RoomModel,c=new WE.Controller;c.update=function(b){a.isSending=!1;a.ui.submit.text("\u53d1\u9001\u9080\u8bf7");a.ui.emailInput.find("input").val("");a.selectList.user=[];a.selectList.mail=[];0==b.data.code?a.ui.emailInput.find(".invite-tips").text("\u5df2\u7ecf\u6210\u529f\u53d1\u9001\u9080\u8bf7").show():
a.ui.emailInput.find(".invite-tips").text("\u53d1\u9001\u9080\u8bf7\u5931\u8d25").show();a.ui.usersList.empty();setTimeout(function(){a.ui.emailInput.find(".invite-tips").hide();a.addUsers(a.datas)},3E3)};b.addObserver(c);b.inviteChat(a.selectList.user,a.selectList.mail,ROOM.id)}};
WE.pageChat.inviteCell=function(a,b){this.data=a;this.select=b||!1;this.list=(this.isUserList="undefined"!=typeof a.name?!0:!1)?WE.pageChat.invite.selectList.user:WE.pageChat.invite.selectList.mail;this.listIndex=this.list.length;var c=WE.kit.tmpl(this.itemTmpl,{user:this.data,select:b});wall=$(c);this.ui={wall:wall,invite:wall.find(".invite-js-btn"),cell:wall.find(".cell")};this.select&&this.addUser();this.init()};
WE.pageChat.inviteCell.prototype={itemTmpl:'<li>\t\t\t\t<div class="cell <% if( select ){ %> select-cell <% } %>">\t\t\t\t\t<% if( typeof user.avatar != "undefined" ){ %>\t\t\t\t\t<img src="<%=user.avatar %>">\t\t\t\t\t<% } %>\t\t\t\t\t<% if( typeof user.name != "undefined" && user.name == "" ){ %>\t\t\t\t\t\t<% user.name = "(\u672a\u8bbe\u7f6e\u6635\u79f0\u7684\u5c0f\u4f19\u4f34)"; %>\t\t\t\t\t<% } %>\t\t\t\t\t<%=user.name || user.mail %>\t\t\t\t\t<% if( select ){ %>\t\t\t\t\t\t<div class="invite-js-btn">\t\t\t\t\t\t\t<span class="select select-type">\u221a</span>\t\t\t\t\t\t\t<span class="btn invite-type invite" style="display:none;">\u9080\u8bf7</span>\t\t\t\t\t\t</div>\t\t\t\t\t<% }else{ %>\t\t\t\t\t\t<div class="invite-js-btn">\t\t\t\t\t\t\t<span class="select select-type hidden">\u221a</span>\t\t\t\t\t\t\t<span class="btn invite-type invite">\u9080\u8bf7</span>\t\t\t\t\t\t</div>\t\t\t\t\t<% } %>\t\t\t\t</div>\t\t\t</li>',init:function(){this.regEvent()},
regEvent:function(){var a=this;this.ui.cell.click(function(){a.select=!0==a.select?!1:!0;a.select?(a.ui.invite.find(".select-type").removeClass("hidden"),a.ui.invite.find(".invite-type").hide(),a.ui.cell.addClass("select-cell"),a.addUser()):(a.ui.invite.find(".select-type").addClass("hidden"),a.ui.invite.find(".invite-type").show(),a.ui.cell.removeClass("select-cell"),a.removeUser())})},prepend:function(a){a.prepend(this.ui.wall)},addUser:function(){this.isUserList?this.list.push(this.data._id):this.list.push(this.data.mail)},
removeUser:function(){for(var a=this.list.length,b=0;b<a;b++)this.isUserList?this.data._id&&this.data._id==this.list[b]&&this.list.splice(b,1):this.data.mail&&this.data.mail==this.list[b]&&this.list.splice(b,1)}};
WE.pageChat.roomEdit={isEditType:!1,init:function(){this.ui={boot:$("#room-edit-boot"),box:$("#room-edit-box"),titleBox:$("#title-box"),checkpwd:$("#checkpwd"),password:$("#password"),topic:$("#topic-name"),form:$("#room-edit-form")};this.regEvent()},regEvent:function(){var a=this;this.ui.boot.click(function(){a.isEditType?(a.isEditType=!1,a.ui.boot.text("\u7f16\u8f91"),a.ui.box.find(".close-btn").click()):(a.isEditType=!0,a.ui.boot.text("\u53d6\u6d88"),a.clear(),a.ui.titleBox.height("100%"),a.ui.topic.focus(),
a.ui.box.show())});this.ui.box.find(".close-btn").click(function(){a.ui.titleBox.height("auto");a.ui.box.hide()});this.ui.box.find(".topic-edit-submit").click(function(){var b=$.trim(a.ui.topic.val()),c=$.trim(a.ui.password.val());if(""!=b)return a.post(ROOM.id,b,c),!1});this.ui.checkpwd.change(function(){if(!a.ui.checkpwd.is(":checked"))return a.ui.password.hide(),a.ui.password.val(""),!1;a.ui.password.show()})},post:function(a,b,c){var d=new WE.api.RoomModel,e=new WE.Controller;e.update=function(a){0==
a.data.code&&location.reload()};d.addObserver(e);d.updateRoomBase(a,b,c)},clear:function(){null==ROOM.password?this.ui.password.hide():this.ui.password.show();null!=ROOM.password?this.ui.checkpwd.attr("checked","checked"):this.ui.checkpwd.removeAttr("checked");this.ui.password.val(null==ROOM.password?"":ROOM.password);this.ui.topic.val(ROOM.topic)}};
WE.pageChat.videoChat={init:function(){this.ui={boot:$("#video-chat"),roomWall:$("#wall-room"),videoWall:$("#video-wall")};this.regEvent()},regEvent:function(){var a=this;this.ui.boot.click(function(){a.boot();a.setOnVideoBoot()})},boot:function(){var a=this;this.ui.roomWall.addClass("video-style");this.ui.videoWall.show();(new WE.pageChat.VideoModule("video-wall")).onClose=function(){a.ui.roomWall.removeClass("video-style");a.setOffVideoBoot();a.ui.videoWall.hide()}},setOnVideoBoot:function(){this.ui.boot.find("i").addClass("video-active").attr("title",
"\u89c6\u9891\u5df2\u7ecf\u5f00\u542f")},setOffVideoBoot:function(){this.ui.boot.find("i").removeClass("video-active").attr("title","\u70b9\u51fb\u5f00\u542f\u89c6\u9891\u804a\u5929")}};WE.pageChat.VideoModule=function(a){var b=this;this.parentId=a;WE.kit.getTmpl("video-chat.ejs",function(a){a=$(a);b.ui={wall:a,close:a.find(".js-close"),view:a.find(".js-view"),list:a.find(".js-list")};b.setList();b.html(b.parentId);b.regEvent()})};
WE.pageChat.VideoModule.prototype={itemTmpl:'<div class="item <% if( typeof isMe != "undefined" ){ %> item-me <% } %>">\t\t\t\t\t<video></video>\t\t\t\t\t<div class="tabs">\t\t\t\t\t\t<i class="arrow"></i>\t\t\t\t\t\t<a class="name" target="_blank" title="CK.Ming" href="http://www.baidu.com">( Me )</a>\t\t\t\t\t\t<% if( typeof isMe != "undefined" ){ %>\t\t\t\t\t\t\t<span class="js-mike mike">\t\t\t\t\t\t\t\t<i class="icon-onmike"></i>\t\t\t\t\t\t\t</span>\t\t\t\t\t\t<% }else{ %>\t\t\t\t\t\t\t<span class="js-sound sound">\t\t\t\t\t\t\t\t<i class="icon-onsound"></i>\t\t\t\t\t\t\t</span>\t\t\t\t\t\t<% } %>\t\t\t\t\t</div>\t\t\t\t</div>',regEvent:function(){var a=
this;a.ui.close.click(function(){a.close()})},close:function(){this.ui.wall.remove();this.onClose()},onClose:function(){},html:function(a){$("#"+a).html(this.ui.wall)},setList:function(){var a;a=""+WE.kit.tmpl(this.itemTmpl,{isMe:!0});for(var b=0;3>b;b++)a+=WE.kit.tmpl(this.itemTmpl,{});this.ui.list.html(a)}};
