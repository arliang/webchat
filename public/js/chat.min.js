(function(f){f.__vchat_config=f.__vchat_config||{};__vchat_config.server=__vchat_config.server||"https://vchat.co";if(f.WebSocket){var d={$:function(a){return document.getElementById(a)},htmlToDom:function(a){var b=document.createElement("DIV"),c=document.createDocumentFragment();for(b.innerHTML=a;b.firstElementChild;)c.appendChild(b.firstElementChild);return c},hasClassName:function(a,b){return a.className.indexOf(b)!=-1},toggleClassName:function(a,b){a.className=this.hasClassName(a,b)?a.className.replace(b,
""):a.className+" "+b},addClassName:function(a,b){if(!this.hasClassName(a,b))a.className=a.className+" "+b},removeClassName:function(a,b){if(this.hasClassName(a,b))a.className=a.className.replace(b,"")},removeElement:function(a){a.parentElement.removeChild(a)},appendHTML:function(a,b){a.appendChild(this.htmlToDom(b))},insertFirstHTML:function(a,b){a.firstElementChild?a.insertBefore(this.htmlToDom(b),a.firstElementChild):a.appendChild(this.htmlToDom(b))},tmpl:function(a,b){var c=!/\W/.test(a)?cache[a]=
cache[a]||tmpl(document.getElementById(a).innerHTML):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+a.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');");return b?c(b):c},ajax:function(a,b,c,e,g){var d=[],f;for(f in c)c[f]!=null&&c[f]!=void 0&&d.push(f+"="+encodeURIComponent(c[f]));var h=
new XMLHttpRequest;h.open(b,a+(b=="get"?"?"+d.join("&"):""),!0);h.withCredentials=!0;h.onload=function(){e(JSON.parse(h.responseText))};h.onerror=function(){g(h)};h.setRequestHeader("Content-Type","application/x-www-form-urlencoded");h.send(b=="post"?d.join("&"):null)},get:function(a,b,c,e){this.ajax(a,"get",b||{},c||this.empty,e||this.empty)},post:function(a,b,c,e){this.ajax(a,"post",b||{},c||this.empty,e||this.empty)},empty:function(){}};f.__vchat={user:null,room:null,isStart:0,ui:{},config:{},
init:function(){this.setConfig();this.loadAkim();this.addMainUI()},loadAkim:function(){var a=document.createElement("link");a.setAttribute("rel","stylesheet");a.setAttribute("type","text/css");a.setAttribute("charset","utf-8");a.href=this.config.server+"/css/__chat.css";document.getElementsByTagName("head")[0].appendChild(a)},setConfig:function(){this.config.server=f.__vchat_config.server;this.config.domain=f.__vchat_config.domain||document.domain;this.config.uid=f.__vchat_config.uid||"";this.config.uname=
f.__vchat_config.uname||"\u533f\u540d";this.config.uavatar=f.__vchat_config.uavatar||null;this.config.topic=f.__vchat_config.topic||"";this.config.des=f.__vchat_config.des||""},addMainUI:function(){d.appendHTML(document.body,'<div class="vchat-wrapper">\t\t\t\t\t\t\t<div class="vchat-chats-wrapper" id="__vchat_chat_wrap"></div>\t\t\t\t\t\t\t<div class="vchat-main vchat-main-mini" id="__vchat_main" >\t\t\t\t\t\t\t\t<div class="vchat-self-card" id="__vchat_self" ><div class="vchat-loading" title="loading"></div></div>\t\t\t\t\t\t\t\t<div class="vchat-user-list" id="__vchat_online_user">\t\t\t\t\t\t\t\t\t<div class="vchat-loading" title="loading"></div>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div class="vchat-user-init" id="__vchat_init" onclick="__vchat.openAndClose()" >V-chat</div>\t\t\t\t\t\t\t</div>\t\t\t\t\t</div>');
this.ui.chat_main=d.$("__vchat_main")},openAndClose:function(){d.toggleClassName(this.ui.chat_main,"vchat-main-mini");if(this.isStart==0)this.isStart=1,this.userList.init(),this.chat.init(),this.createUser()},createUser:function(){var a=this;this.api.create(this.config.domain,this.config.uid,this.config.uname,this.config.uavatar,function(b){b.code==0?(a.user=b.result.user,a.userList.addMe(a.user),a.login()):alert(b.msg)})},login:function(){var a=this;this.api.login(this.config.domain,this.config.topic,
this.config.des,function(b){if(b.code==0)a.room=b.result,a.socketController.init(a.room)})}};__vchat.api={server:__vchat_config.server,create:function(a,b,c,e,g,f){d.post(this.server+"/sys/vchat-create",{domain:a,uid:b,uname:c,uavatar:e},g,f)},login:function(a,b,c,e,g){d.post(this.server+"/sys/vchat-login",{domain:a,topic:b,des:c},e,g)},postMessage:function(a,b,c,e,g,f,i){d.post(this.server+"/sys/post",{roomid:a,text:b,to:c,from:e,aim:g},f,i)},history:function(a,b,c,e,g){d.get(this.server+"/sys/vchat-history",
{to:b,limit:c||10,roomid:a},e,g)}};__vchat.userList={list:[],ui:{},init:function(){this.ui.list=d.$("__vchat_online_user")},initList:function(a){for(var b="",c=0;c<a.length;c++)this.hasOnline(a[c])==!1&&(this.list.push(a[c]),a[c]._id!=__vchat.user._id&&(b+=d.tmpl('<div class="vchat-user-card vchat-user-card-self" id="__vchat_uid_<%=_id%>" onclick="__vchat.chat.open(\'<%=_id%>\')" >\t\t\t\t\t\t<div class="vchat-user-avatar">\t\t\t\t\t\t\t<img src="<%=avatar%>" alt="<%=name%>" style="width:36px;height:36px;" width="36" height="36" />\t\t\t\t\t\t</div>\t\t\t\t\t\t<div class="vchat-user-info">\t\t\t\t\t\t\t<div class="vchat-user-name"><%=name%></div>\t\t\t\t\t\t\t<div class="vchat-user-talk"><%if(_id == __vchat.user._id){%>(\u6211\u81ea\u5df1)<%}%></div>\t\t\t\t\t\t</div>\t\t\t\t\t</div>',
a[c])));this.ui.list.innerHTML=b==""?'<div style="text-align:center;margin:10px 0;">\u6ca1\u6709\u5176\u4ed6\u7528\u6237\u5728\u7ebf</div>':b||'<div style="text-align:center;margin:10px 0;">\u6ca1\u6709\u5176\u4ed6\u7528\u6237\u5728\u7ebf</div>'},addMe:function(a){d.$("__vchat_self").innerHTML=d.tmpl('<div class="vchat-user-card vchat-user-card-self" id="__vchat_uid_<%=_id%>" onclick="__vchat.chat.open(\'<%=_id%>\')" >\t\t\t\t\t\t<div class="vchat-user-avatar">\t\t\t\t\t\t\t<img src="<%=avatar%>" alt="<%=name%>" style="width:36px;height:36px;" width="36" height="36" />\t\t\t\t\t\t</div>\t\t\t\t\t\t<div class="vchat-user-info">\t\t\t\t\t\t\t<div class="vchat-user-name"><%=name%></div>\t\t\t\t\t\t\t<div class="vchat-user-talk"><%if(_id == __vchat.user._id){%>(\u6211\u81ea\u5df1)<%}%></div>\t\t\t\t\t\t</div>\t\t\t\t\t</div>',
a)},getUser:function(a){for(var b=0;b<this.list.length;b++)if(this.list[b]._id==a)return this.list[b];return null},online:function(a){if(a._id!=__vchat.user._id&&this.hasOnline(a)==!1){var b="";if(this.hasOnline(a)==!1){console.log(this.list.length);if(this.list.length==1)this.ui.list.innerHTML="";this.list.push(a);a._id!=__vchat.user._id&&(b+=d.tmpl('<div class="vchat-user-card vchat-user-card-self" id="__vchat_uid_<%=_id%>" onclick="__vchat.chat.open(\'<%=_id%>\')" >\t\t\t\t\t\t<div class="vchat-user-avatar">\t\t\t\t\t\t\t<img src="<%=avatar%>" alt="<%=name%>" style="width:36px;height:36px;" width="36" height="36" />\t\t\t\t\t\t</div>\t\t\t\t\t\t<div class="vchat-user-info">\t\t\t\t\t\t\t<div class="vchat-user-name"><%=name%></div>\t\t\t\t\t\t\t<div class="vchat-user-talk"><%if(_id == __vchat.user._id){%>(\u6211\u81ea\u5df1)<%}%></div>\t\t\t\t\t\t</div>\t\t\t\t\t</div>',
a))}d.appendHTML(this.ui.list,b)}else console.log("on-line miss self",a._id)},offline:function(a){if(a._id==__vchat.user._id)return!1;for(var b=0,c=0;c<this.list.length;c++)if(this.list[c]._id==a._id){this.list.splice(c,1);b=1;break}if(b&&(d.removeElement(d.$("__vchat_uid_"+a._id)),this.list.length==1))this.ui.list.innerHTML='<div style="text-align:center;margin:10px 0;">\u6ca1\u6709\u5176\u4ed6\u7528\u6237\u5728\u7ebf</div>'},hasOnline:function(a){for(var b=0;b<this.list.length;b++)if(this.list[b]._id==
a._id)return!0;return!1}};__vchat.socketController={socket:null,weightTime:0,room:null,serverHost:__vchat_config.server.replace("https://",""),init:function(a){if(!this.room&&a)this.room=a;var b=this.room.id,c=this.socket=new WebSocket("wss://"+this.serverHost+"/s"),e={connection:function(a){a.code==0?c.send(JSON.stringify({type:"login",data:{roomid:b}})):console.log(a.msg)},"on-line":function(a){__vchat.userList.online(a)},"off-line":function(a){__vchat.userList.offline(a)},"user-list":function(a){__vchat.userList.initList(a)},
"new-chat":function(a){__vchat.chat.newMessage(a)}};c.onopen=function(){window.console&&console.log("onopen")};c.onmessage=function(a){a=JSON.parse(a.data);if(e[a.type])e[a.type](a.data);else window.console&&console.log("onmessage miss",a)};c.onclose=function(){__vchat.socketController.startDisconnectionWeightTraining()}},startDisconnectionWeightTraining:function(){var a=this;setTimeout(function(){console.log("\u91cd\u65b0\u8fde\u63a5"+a.weightTime/2E3+"\u6b21");a.socket&&a.socket.close();a.init()},
this.weightTime+=2E3)}};__vchat.chat=function(a,b,c){this.roomid=b;this.ishistory=c;this.chat_item='<div class="<%=isSelf ? \'vchat-chat-right\' : \'vchat-chat-left\'%>">\t\t\t\t\t\t\t<div class="vchat-chat-avatar"><img src="<%=from.avatar%>" style="width:24px;height:24px;" width="24" alt="" /></div>\t\t\t\t\t\t\t<div class="vchat-chat-info">\t\t\t\t\t\t\t\t<%=text%>\t\t\t\t\t\t\t\t<%if(!_id){%><div class="vchat-chat-status">...</div><%}%>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>';this.user=a;this.wrap=
__vchat.chat.ui.wrap;this.ui={};this.init()};__vchat.chat.prototype={constructor:__vchat.chat,init:function(){this.addUI()},addUI:function(){var a=d.tmpl('<div class="vchat-chats-item" id="__vchat_<%=_id%>" >\t\t\t\t\t<div class="vchat-chats-item-in">\t\t\t\t\t\t<div class="vchat-chat-title">\t\t\t\t\t\t\t<span class="vchat-chat-title-name"><%=name ? name : "??"%></span>\t\t\t\t\t\t\t<div class="vchat-chat-item-setting">\t\t\t\t\t\t\t\t<span class="vchat-chat-item-set vchat-chat-item-set-mini" title="\u6700\u5c0f\u5316" >\uff3f</span>\t\t\t\t\t\t\t\t<span class="vchat-chat-item-set vchat-chat-item-set-noraml" title="\u8fd8\u539f" >\uffe3</span>\t\t\t\t\t\t\t\t<span class="vchat-chat-item-set vchat-chat-item-set-close" title="\u5173\u95ed" >\u3128</span>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>\t\t\t\t\t\t<div class="vchat-chat-context"><div class="vchat-loading" title="loading"></div></div>\t\t\t\t\t\t<div class="vchat-chat-enter" z-index="0">\t\t\t\t\t\t\t\t<input type="text" class="vchat-chat-input" placeholder="\u53d1\u6d88\u606f" />\t\t\t\t\t\t</div>\t\t\t\t\t</div>\t\t\t\t</div>',
this.user),b=null;d.insertFirstHTML(this.wrap,a);this.ui.wrap=d.$("__vchat_"+this.user._id);b=this.ui.wrap.getElementsByClassName("vchat-chat-item-set");this.ui.mini=b[0];this.ui.noraml=b[1];this.ui.close=b[2];this.ui.input=this.ui.wrap.getElementsByClassName("vchat-chat-input")[0];this.ui.list=this.ui.wrap.getElementsByClassName("vchat-chat-context")[0];this.regEvent();this.initChats()},regEvent:function(){var a=this;this.ui.mini.onclick=function(){a.setMini()};this.ui.noraml.onclick=function(){a.setNoraml()};
this.ui.close.onclick=function(){a.setClose()};this.ui.input.onkeyup=function(b){b=b||window.event;if(b.keyCode==13&&this.value!="")a.sendMessage(this.value),this.value=""};this.ui.input.focus()},initChats:function(){this.ishistory?this.getHistory():this.ui.list.innerHTML=""},getHistory:function(){var a=this;__vchat.api.history(this.roomid,this.user._id,10,function(b){var c=b.result;b.code=="0"?a.insertHistoryChats(c):console.log("\u8bfb\u53d6\u804a\u5929\u8bb0\u5f55\u9519\u8bef")})},insertHistoryChats:function(a){for(var b=
"",c=null,c=null,e=0;e<a.length;e++)c=a[e],c.isSelf=c.from._id==__vchat.user._id,b+=d.tmpl(this.chat_item,c);(c=this.ui.list.getElementsByClassName("vchat-loading"))&&d.removeElement(c[0]);b&&d.insertFirstHTML(this.ui.list,b)},addChat:function(a){a.isSelf=a.from._id==__vchat.user._id;a=d.tmpl(this.chat_item,a);d.appendHTML(this.ui.list,a);this.ui.list.scrollTop=this.ui.list.scrollHeight},addMessage:function(a){this.ui.list.appendChild(a.ui.wrap);this.ui.list.scrollTop=this.ui.list.scrollHeight},setClose:function(){d.removeElement(this.ui.wrap);
__vchat.chat.close(this.user._id)},setMini:function(){d.addClassName(this.ui.wrap,"vchat-chats-item-mini")},setNoraml:function(){d.removeClassName(this.ui.wrap,"vchat-chats-item-mini");this.ui.input.focus()},newChat:function(a){if(a.to._id==this.user._id&&a.from._id==__vchat.user._id)return!0;return a.from._id==this.user._id&&a.to._id==__vchat.user._id?(this.addChat(a),!0):!1},sendMessage:function(a){var b=this.user,c=this.roomid,e=__vchat.user;this.localMessage(a);this.addMessage(new __vchat.Message(c,
b,e,a,null))},localMessage:function(a){return{from:__vchat.user,to:this.user,text:a,time:parseInt((new Date).getTime()/1E3)}}};__vchat.chat.list=[];__vchat.chat.ui={};__vchat.chat.close=function(a){for(var b=0;b<this.list.length;b++)if(this.list[b].user._id==a)return this.list.splice(b,1),a};__vchat.chat.open=function(a,b){var c=__vchat.userList.getUser(a),e=null;if(a==__vchat.user._id)return window.console&&console.log("miss self"),!1;if(c){for(e=0;e<this.list.length;e++)if(this.list[e].user._id==
a){this.list[e].setNoraml();return}this.list.length>6&&this.list[0].setClose();e=new __vchat.chat(c,__vchat.room.id,b==void 0?!0:!1);this.list.push(e)}};__vchat.chat.newMessage=function(a){var b=0;if(a.to&&a.to._id==__vchat.user._id||a.from._id==__vchat.user._id)for(var c=0;c<this.list.length;c++){if(this.list[c].newChat(a)){b=2;break}}else b=1;b==0&&(this.open(a.from._id,!1),this.newMessage(a))};__vchat.chat.init=function(){this.ui.wrap=d.$("__vchat_chat_wrap")};__vchat.Message=function(a,b,c,e,
d){this.parentElement=null;this.chat_item='<div class="<%=isSelf ? \'vchat-chat-right\' : \'vchat-chat-left\'%>">\t\t\t\t\t\t\t<div class="vchat-chat-avatar"><img src="<%=from.avatar%>" style="width:24px;height:24px;" width="24" alt="" /></div>\t\t\t\t\t\t\t<div class="vchat-chat-info">\t\t\t\t\t\t\t\t<%=text%>\t\t\t\t\t\t\t\t<%if(!_id){%><div class="vchat-chat-status">...</div><%}%>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>';this.ui={};this.data={isSelf:c._id==__vchat.user._id,roomid:a,to:b,from:c,text:e,
_id:d,time:parseInt((new Date).getTime()/1E3)};this.interid=null;this.init()};__vchat.Message.prototype={constructor:__vchat.Message,init:function(){this.ui.wrap=d.htmlToDom(d.tmpl(this.chat_item,this.data)).firstChild;this.ui.status=this.ui.wrap.getElementsByClassName("vchat-chat-status")[0];this.data._id||this.postMessage()},appendTo:function(a){a.appendChild(this.ui.wrap)},setTime:function(a){this.data.time=a},postMessage:function(){var a=this,b=this.data.roomid,c=this.data.text,d=this.data.to._id,
f=this.data.from._id;a.showSendIngStatus();__vchat.api.postMessage(b,c,d,f,null,function(){a.stopSendIngStatus();a.ui.status.innerHTML=""},function(){a.ui.status.innerHTML="error"})},stopSendIngStatus:function(){clearInterval(this.interid)},showSendIngStatus:function(){var a=this,b=0;this.interid=setInterval(function(){a.ui.status.innerHTML="...".slice(0,++b%3+1)},300)}};(__vchat_config.init==void 0||__vchat_config.init)&&__vchat.init()}else window.console&&window.console.log("vchat not support your browser")})(window);
