WE.pageChat={chatTmpl:'<% for(var i = 0;i<obj.length;i++){ %>\t\t\t\t\t<div class="chat <% if(obj[i].from._id == USER._id){ %> my <% } %>">\t\t\t\t\t\t<input name="uid" type="hidden" value="<%=obj[i].from._id%>"/>\t\t\t\t\t\t<input name="txt" type="hidden" value="<%=obj[i].text%>"/>\t\t\t\t\t\t<input name="uname" type="hidden" value="<%=obj[i].from.name%>"/>\t\t\t\t\t\t<input name="mid" type="hidden" value="<%=obj[i]._id%>"/>\t\t\t\t\t\t<div class="avator">\t\t\t\t\t\t\t<a href="/user/<%=obj[i].from._id%>">\t\t\t\t\t\t\t\t<img width="32" height="32" src="<%=obj[i].from.avatar%>" alt="<%=obj[i].from.name%>"/>\t\t\t\t\t\t\t</a>\t\t\t\t\t\t</div>\t\t\t\t\t\t<div class="info">\t\t\t\t\t\t\t<div class="talk">\t\t\t\t\t\t\t\t<i class="arrow"></i>\t\t\t\t\t\t\t\t<div class="talk-cont">\t\t\t\t\t\t\t\t\t<% if( obj[i].aim ){ %>\t\t\t\t\t\t\t\t\t<div class="review-orig">\t\t\t\t\t\t\t\t\t\t<span><%=obj[i].aim.text %></span>\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t<% } %>\t\t\t\t\t\t\t\t\t<a class="name" href="/user/<%=obj[i].from._id%>"><%=obj[i].from.name%> : </a><%=WE.markdown.format(obj[i].text)%>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<p class="review-time">\t\t\t\t\t\t\t\t\t<a class="review-btn" href="javascript:;">\u56de\u590d</a>\t\t\t\t\t\t\t\t\t<span class="time"><%=WE.kit.format( new Date( obj[i].time * 1000),"MM-dd hh:mm:ss")%></span>\t\t\t\t\t\t\t\t</p>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>\t\t\t\t\t</div>\t\t\t\t<% } %>',
init:function(){this.ui={backBtn:$("#chat-title .back"),setBtn:$("#chat-title .setting"),container:$("#chat-container"),inputArea:$("#talk-input"),sendBtn:$("#send-btn")};this.regEvent();WE.pageChat.review.init();WE.pageChat.lazyloadData.init()},regEvent:function(){var a=this;this.ui.setBtn.click(function(){alert("\u8bbe\u7f6e\u7684\u6309\u94ae")});$("#sendForm").submit(function(){var b=a.ui.inputArea.val();b&&(a.post(ROOM.id,b,WE.pageChat.review._id),WE.pageChat.review.clear(),$("#talk-input").val(""));
return!1})},prepend:function(a){a=WE.kit.tmpl(this.chatTmpl,a);$(a).prependTo(this.ui.container)},append:function(a){if(a){var b=WE.kit.tmpl(this.chatTmpl,a);$(b).appendTo(this.ui.container)}(b=a.length)&&a[b-1].time?WE.pageChat.lazyloadData.lastTime=a[b-1].time:(WE.pageChat.lazyloadData.isLoading=2,WE.pageChat.lazyloadData.lastTime=-1)},clear:function(){this.ui.inputArea.val("")},post:function(a,b,c){var d=this;d.ui.sendBtn.attr("disabled","disabled").text("\u53d1\u9001\u4e2d...");c=c?c:void 0;var e=
new WE.api.RoomModel,f=new WE.Controller;f.update=function(a){0==a.data.code&&(d.review._id=null,d.ui.inputArea.val(""),d.ui.sendBtn.removeAttr("disabled").text("\u53d1\u9001"))};e.addObserver(f);e.mpostChat(a,b,c)}};
WE.pageChat.lazyloadData={isLoading:0,lastTime:null,init:function(){this.regEvent()},regEvent:function(){var a=this;$(window).bind("scroll",function(){0==a.isLoading&&$(window).scrollTop()+$(window).height()+50>$(document.body).height()&&(a.isLoading=1,a.getMore())})},getMore:function(){var a=this;$("#timeline-loading").show();var b=new WE.api.RoomModel,c=new WE.Controller;c.update=function(b){$("#timeline-loading").hide();b=b.data;0==b.code&&b.result.length?(a.isLoading=0,WE.pageChat.append(b.result)):
a.isLoading=2};c.error=function(){};b.addObserver(c);b.getMore(ROOM.id,this.lastTime)}};
WE.pageChat.review={_id:null,init:function(){this.regEvent()},reviewOrigTmpl:'<p>\t\t\t\t\t\t<span class="review-cont"><%=text%></span>\t\t\t\t\t\t<a class="review-uname" href="/user/<%=uid%>"><%=uname%></a>\t\t\t\t\t\t<a class="review-del" href="javascript:;" style="margin-left:10px;font-weight:bold;">\u00d7</a>\t\t\t\t\t  </p>',regEvent:function(){var a=this;$("#chat-container").delegate(".review-btn","click",function(){var b=$(this).closest(".chat"),c=b.find("input[name=uid]").val();uname=b.find("input[name=uname]").val();
text=b.find("input[name=txt]").val();mid=b.find("input[name=mid]").val();a._id=mid;a.setOrigData(text,uname,c)});$("#review-box").delegate(".review-del","click",function(){a._id=null;a.clear()})},setOrigData:function(a,b,c){var d=$("#review-box");d.empty();a=WE.kit.tmpl(this.reviewOrigTmpl,{text:a,uid:c,uname:b});$(a).appendTo(d)},clear:function(){$("#review-box").empty()}};
